
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 19.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2025 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: 22-user 8-core network, expiring 30 Jun 2026
Serial number: 501909306443
  Licensed to: Jeffrey Ohl
               University of Chicago

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.

. do chicago_synth_placebo_topq.do 

. /*
> Placebo tests - TOP QUARTILE ONLY (by pre-treatment outcome)
> Filters out noisy small ZIP3s that produce meaningless placebo ratios.
> Includes pre_median_price matching.
> 
> Outcome: Set by $outcome_var from data/synth_config.do
> 
> INCREMENTAL: Resumes if main synth unchanged. Restarts if main synth is newer
> .
> */
. 
. clear all

. set more off

. 
. * Load config (outcome_var, outcome_label, outdir from Python)
. include "data/synth_config.do"

. * Auto-generated by export_synth_data.py
. * DO NOT EDIT - change settings in load_chatgpt_data.py
. 
. global outcome_var "log_trans"

. global outcome_label "Log Transactions"

. global outdir "/Users/jeffreyohl/Dropbox/LLM_PassThrough/output/trans/15to25/
> all_merchants"

. 
. 
. * ===========================================================================
. * Smart resume: restart if main synth changed
. * ===========================================================================
. local main_synth "$outdir/chicago_synth_stata.png"

. local placebo_file "$outdir/placebo_results_topq.dta"

. 
. capture confirm file "`main_synth'"

. local main_exists = (_rc == 0)

. 
. capture confirm file "`placebo_file'"

. local placebo_exists = (_rc == 0)

. 
. if `main_exists' & `placebo_exists' {
.     quietly shell stat -f "%m" "`main_synth'" > /tmp/main_mtime.txt
.     quietly shell stat -f "%m" "`placebo_file'" > /tmp/placebo_mtime.txt
. 
.     file open main_f using "/tmp/main_mtime.txt", read
.     file read main_f main_mtime
.     file close main_f
. 
.     file open placebo_f using "/tmp/placebo_mtime.txt", read
.     file read placebo_f placebo_mtime
.     file close placebo_f
. 
.     if `main_mtime' > `placebo_mtime' {
.         di "WARNING: Main synth is newer than placebo results"
.         di "RESTARTING FRESH (deleting old placebo results)"
.         erase "`placebo_file'"
.         capture erase "$outdir/placebo_series_long.dta"
.     }
. }

. 
. * ===========================================================================
. * Check for existing results (incremental mode)
. * ===========================================================================
. local done_units ""

. capture confirm file "$outdir/placebo_results_topq.dta"

. if _rc == 0 {
.     use "$outdir/placebo_results_topq.dta", clear
.     count
  0
.     local n_done = r(N)
.     di "INCREMENTAL MODE: Found `n_done' completed units"
INCREMENTAL MODE: Found 0 completed units
.     levelsof zip3_id, local(done_units)

. }

. else {
.     di "FRESH START: No existing results found"
.     local n_done = 0
. }

. 
. * Create output file for summary results (append mode if exists)
. tempname results

. if `n_done' > 0 {
.     * Append to existing file
.     postfile `results' int(zip3_id) double(pre_rmspe post_rmspe ratio ///
>         pre_gap_mean post_gap_mean final_gap) ///
>         using "$outdir/placebo_results_new.dta", replace
. }

. else {
.     * Fresh start
.     postfile `results' int(zip3_id) double(pre_rmspe post_rmspe ratio ///
>         pre_gap_mean post_gap_mean final_gap) ///
>         using "$outdir/placebo_results_topq.dta", replace
. 
.     * Create empty dataset for full series (long format)
.     clear
.     gen int zip3_id = .
.     gen int month_num = .
.     gen double y_treated = .
.     gen double y_synthetic = .
.     gen double gap = .
.     save "$outdir/placebo_series_long.dta", replace
(dataset contains 0 observations)
file
    /Users/jeffreyohl/Dropbox/LLM_PassThrough/output/trans/15to25/all_merchan
    > ts/placebo_series_long.dta saved
. }

. 
. * ===========================================================================
. * First: Get Chicago's RMSPE from already-computed results
. * ===========================================================================
. use "$outdir/synth_results.dta", clear

. gen gap = _Y_treated - _Y_synthetic
(712 missing values generated)

. gen gap_sq = gap^2
(712 missing values generated)

. 
. sum gap_sq if _time < 10

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
      gap_sq |          7    .0001957    .0003135   2.05e-07   .0008117

. local chicago_pre_rmspe = sqrt(r(mean))

. 
. sum gap_sq if _time >= 10

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
      gap_sq |         14    .0156909    .0161203   1.46e-06   .0501989

. local chicago_post_rmspe = sqrt(r(mean))

. 
. local chicago_ratio = `chicago_post_rmspe' / `chicago_pre_rmspe'

. 
. * Signed gaps
. sum gap if _time < 10

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
         gap |          7     -.00083    .0150819  -.0208025   .0284912

. local chicago_pre_gap = r(mean)

. 
. sum gap if _time >= 10

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
         gap |         14   -.1023477    .0749474  -.2240511   .0259597

. local chicago_post_gap = r(mean)

. 
. * Final period gap (month 21)
. sum gap if _time == 21

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
         gap |          1   -.1894422           .  -.1894422  -.1894422

. local chicago_final_gap = r(mean)

. 
. di "Chicago: pre_rmspe=`chicago_pre_rmspe', post_rmspe=`chicago_post_rmspe', 
> ratio=`chicago_ratio'"
Chicago: pre_rmspe=.01398780356318, post_rmspe=.125263470941695, ratio=8.955192
> 312782057

. di "  pre_gap=`chicago_pre_gap', post_gap=`chicago_post_gap', final_gap=`chic
> ago_final_gap'"
  pre_gap=-.0008299939134823, post_gap=-.1023476971396511, final_gap=-.18944221
> 73500061

. post `results' (606) (`chicago_pre_rmspe') (`chicago_post_rmspe') (`chicago_r
> atio') ///
>     (`chicago_pre_gap') (`chicago_post_gap') (`chicago_final_gap')

. 
. * Add Chicago's series to long dataset
. use "$outdir/synth_results.dta", clear

. gen int zip3_id = 606

. gen gap = _Y_treated - _Y_synthetic
(712 missing values generated)

. rename _time month_num

. rename _Y_treated y_treated

. rename _Y_synthetic y_synthetic

. keep zip3_id month_num y_treated y_synthetic gap

. append using "$outdir/placebo_series_long.dta"
(variable gap was float, now double to accommodate using data's values)

. save "$outdir/placebo_series_long.dta", replace
file
    /Users/jeffreyohl/Dropbox/LLM_PassThrough/output/trans/15to25/all_merchan
    > ts/placebo_series_long.dta saved

. 
. * ===========================================================================
. * Identify TOP QUARTILE units by pre-period usage
. * ===========================================================================
. use "data/synth_panel.dta", clear

. 
. * Balance panel first
. bysort zip3_id: gen n_months = _N

. keep if n_months == 21
(2,071 observations deleted)

. drop n_months

. 
. * Compute pre-period mean $outcome_var by unit
. bysort zip3_id: egen pre_mean_log = mean($outcome_var) if month_num < 10
(10,276 missing values generated)

. bysort zip3_id: egen pre_avg_log = max(pre_mean_log)

. drop pre_mean_log

. 
. * Convert to level (exp of log)
. gen pre_avg_outcome = exp(pre_avg_log)

. 
. * Get 75th percentile
. quietly sum pre_avg_outcome, detail

. local q75 = r(p75)

. di "Top quartile threshold: `q75' ($outcome_label)"
Top quartile threshold: 49.79880142211914 (Log Transactions)

. 
. * Keep only top quartile
. keep if pre_avg_outcome >= `q75'
(11,550 observations deleted)

. 
. * Get list of qualifying units
. levelsof zip3_id, local(top_units)
15 56 60 62 65 66 69 72 77 80 82 87 94 99 162 171 172 173 174 175 181 182 184 1
> 85 187 189 196 197 198 199 205 207 208 210 216 243 246 247 248 251 252 253 25
> 7 258 261 263 265 266 267 268 271 272 273 274 276 277 290 291 292 293 295 296
>  297 298 299 300 301 302 303 304 305 306 307 308 310 312 313 314 317 333 335 
> 480 481 497 498 499 500 504 546 613 616 668 669 670 677 678 679 687 688 689 6
> 90 695 696 697 700 701 702 714 715 716 717 718 719 720 724 747 748 750 751 75
> 5 757 758 759 760 763 770 782 783 785 786 789 790 792 794 795 796 797 798 799
>  800 801 803 804 806 807 808 809 810 812 813 814 815 816 817 819 820 823 824 
> 825 826 827 828 829 830 831 833 834 835 837 838 840 841 842 843 848 850 851 8
> 52 858 859 860 861 863 864

. local n_units : word count `top_units'

. di "Top quartile units: `n_units'"
Top quartile units: 184

. 
. * Save to file for reference
. preserve

. keep zip3_id zip3 pre_avg_outcome

. duplicates drop

Duplicates in terms of all variables

(3,680 observations deleted)

. gsort -pre_avg_outcome

. export delimited using "$outdir/placebo_valid_units.csv", replace
file /Users/jeffreyohl/Dropbox/LLM_PassThrough/output/trans/15to25/all_merchant
> s/placebo_valid_units.csv saved

. restore

. 
. * ===========================================================================
. * Run placebos on top quartile units only
. * ===========================================================================
. 
. * Get Chicago's zip3_id ONCE before the loop
. quietly sum zip3_id if zip3 == "606", meanonly

. local chicago_id = r(mean)

. di "Chicago zip3_id = `chicago_id'"
Chicago zip3_id = 546

. 
. local i = 0

. 
. foreach unit of local top_units {
  2.     * Skip Chicago (already have its results)
.     if `unit' == `chicago_id' continue
  3. 
.     * Skip if already completed (incremental mode)
.     local skip = 0
  4.     foreach done of local done_units {
  5.         if `unit' == `done' {
  6.             local skip = 1
  7.             continue, break
  8.         }
  9.     }
 10.     if `skip' == 1 continue
 11. 
.     local ++i
 12. 
.     * Progress every 20 units
.     if mod(`i', 20) == 0 {
 13.         di "Progress: `i'/`n_units' completed"
 14.     }
 15. 
.     di "Placebo `i': zip3_id = `unit'"
 16. 
.     quietly {
 17.         * Load data fresh
.         use "data/synth_panel.dta", clear
 18. 
.         * Balance panel
.         bysort zip3_id: gen n_months = _N
 19.         keep if n_months == 21
 20.         drop n_months
 21. 
.         * Set panel structure
.         tsset zip3_id month_num
 22. 
.         * Create pre-period means
.         bysort zip3_id: egen pre_early_tmp = mean($outcome_var) if inrange(mo
> nth_num, 3, 6)
 23.         bysort zip3_id: egen pre_mean_early = max(pre_early_tmp)
 24.         drop pre_early_tmp
 25. 
.         bysort zip3_id: egen pre_late_tmp = mean($outcome_var) if inrange(mon
> th_num, 7, 9)
 26.         bysort zip3_id: egen pre_mean_late = max(pre_late_tmp)
 27.         drop pre_late_tmp
 28. 
.         * Run synth (with pre_median_price matching)
.         capture synth $outcome_var ///
>             pct_college pct_hh_100k pct_young ///
>             median_age median_income pct_stem pct_broadband ///
>             pre_mean_early pre_mean_late pre_median_price, ///
>             trunit(`unit') trperiod(10) ///
>             keep("$outdir/placebo_temp", replace)
 29.     }
 30. 
.     if _rc != 0 {
 31.         di "  Failed, skipping"
 32.         continue
 33.     }
 34. 
.     * Compute RMSPE and signed gaps from results
.     quietly {
 35.         use "$outdir/placebo_temp.dta", clear
 36.         gen gap = _Y_treated - _Y_synthetic
 37.         gen gap_sq = gap^2
 38. 
.         sum gap_sq if _time < 10
 39.         local pre_rmspe = sqrt(r(mean))
 40. 
.         sum gap_sq if _time >= 10
 41.         local post_rmspe = sqrt(r(mean))
 42. 
.         local ratio = `post_rmspe' / `pre_rmspe'
 43. 
.         * Signed gaps
.         sum gap if _time < 10
 44.         local pre_gap = r(mean)
 45. 
.         sum gap if _time >= 10
 46.         local post_gap = r(mean)
 47. 
.         * Final period gap
.         sum gap if _time == 21
 48.         local final_gap = r(mean)
 49. 
.         * Save full series to long dataset
.         gen int zip3_id = `unit'
 50.         rename _time month_num
 51.         rename _Y_treated y_treated
 52.         rename _Y_synthetic y_synthetic
 53.         keep zip3_id month_num y_treated y_synthetic gap
 54.         append using "$outdir/placebo_series_long.dta"
 55.         save "$outdir/placebo_series_long.dta", replace
 56.     }
 57. 
.     di "  pre=`pre_rmspe', post=`post_rmspe', ratio=`ratio', post_gap=`post_g
> ap'"
 58.     post `results' (`unit') (`pre_rmspe') (`post_rmspe') (`ratio') ///
>         (`pre_gap') (`post_gap') (`final_gap')
 59. }
Placebo 1: zip3_id = 15
  pre=.0342176159424782, post=.1550054021714308, ratio=4.529988367161637, post_
> gap=-.0655120137214128
Placebo 2: zip3_id = 56
  pre=.038445245072834, post=.0552631824521588, ratio=1.43745168869293, post_ga
> p=-.0170336098942373
Placebo 3: zip3_id = 60
  pre=.1186817008196014, post=.0597090675556463, ratio=.5031025604057132, post_
> gap=.0038337660288172
Placebo 4: zip3_id = 62
  pre=.2625837387922729, post=.4628491909114941, ratio=1.762672711723588, post_
> gap=.4544775060244969
Placebo 5: zip3_id = 65
  pre=.0288050383047651, post=.081097131981608, ratio=2.815380112450412, post_g
> ap=-.0448816750597741
Placebo 6: zip3_id = 66
  pre=.2108964852821046, post=.0626039453154667, ratio=.2968467930213481, post_
> gap=-.0368252759674631
Placebo 7: zip3_id = 69
  pre=.0308073928873804, post=.1796167428521729, ratio=5.830312987170982, post_
> gap=.1667076945304871
Placebo 8: zip3_id = 72
  pre=.0686732990807574, post=.0477932073372758, ratio=.6959503617420894, post_
> gap=-.012591791052338
Placebo 9: zip3_id = 77
  pre=.0238156646387153, post=.0743713916427514, ratio=3.122793034373331, post_
> gap=.0547774267116828
Placebo 10: zip3_id = 80
  pre=.1937096287268272, post=.266230572091467, ratio=1.374379651859795, post_g
> ap=.2625392121928079
Placebo 11: zip3_id = 82
  pre=.0173552666883899, post=.0649357921191448, ratio=3.741561180536897, post_
> gap=-.0432202679221518
Placebo 12: zip3_id = 87
  pre=.0674800246461848, post=.0788040102987203, ratio=1.167812411330762, post_
> gap=.0682648989812671
Placebo 13: zip3_id = 94
  pre=.0309841243050113, post=.0543233996034045, ratio=1.753265610111768, post_
> gap=-.0004429305554368
Placebo 14: zip3_id = 99
  pre=.1319254558805109, post=.2251027633930548, ratio=1.70628755376019, post_g
> ap=-.1883986103348434
Placebo 15: zip3_id = 162
  pre=.0619730097912242, post=.1503160937036763, ratio=2.425509011262546, post_
> gap=-.1249681343989713
Placebo 16: zip3_id = 171
  pre=.029077630221478, post=.140328014331268, ratio=4.825978364207122, post_ga
> p=-.1302688233554363
Placebo 17: zip3_id = 172
  pre=.3377805990608088, post=.5153774285368459, ratio=1.525775695732203, post_
> gap=.5050687087433678
Placebo 18: zip3_id = 173
  pre=.0469960753149417, post=.041282655041446, ratio=.8784277147568702, post_g
> ap=.0141793983576853
Placebo 19: zip3_id = 174
  pre=.0689489572674891, post=.2937803099526199, ratio=4.260837605025588, post_
> gap=.2877258828708104
Progress: 20/184 completed
Placebo 20: zip3_id = 175
  pre=.1974945109621649, post=.4124448856183799, ratio=2.088386576462341, post_
> gap=.3988688598786082
Placebo 21: zip3_id = 181
  pre=.0407983957477802, post=.1047579507876238, ratio=2.567697794669379, post_
> gap=.0937161180855972
Placebo 22: zip3_id = 182
  pre=.0268172790687225, post=.0620643108739383, ratio=2.314340344331394, post_
> gap=.0415789443400821
Placebo 23: zip3_id = 184
  pre=.1051380319820005, post=.0765817021296564, ratio=.7283920070214658, post_
> gap=.0267475517466664
Placebo 24: zip3_id = 185
  pre=.0351941844766846, post=.0388016562806884, ratio=1.102501929158031, post_
> gap=-.0307050551553922
Placebo 25: zip3_id = 187
  pre=.0568578483463976, post=.0309823588262156, ratio=.5449090974646174, post_
> gap=-.0015823765383435
Placebo 26: zip3_id = 189
